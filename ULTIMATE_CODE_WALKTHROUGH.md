# ๐ง ULTIMATE CODE WALKTHROUGH - ุดุฑุญ ููุฏ ูุดุฑูุน Invoicely ุณุทุฑ ุจุณุทุฑ

ูุฐุง ุงูููู ูู ูุฑุงุฌุนุฉ ุจุฑูุฌูุฉ ุดุงููุฉ (Line-by-Line Review). ุณูููู ุจูุถุน ุฃูู ุฃุฌุฒุงุก ุงูููุฏ ูุชุญุชูุง ุดุฑุญ ููุตู ุฌุฏุงู ููู ุณุทุฑ ููุงุฐุง ูุญุฏุซ ูู ุงูุฎูููุฉ.

---

## 1. ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช (Database Schema)
**ุงููุณุงุฑ:** `app/config/schema.ts`

```tsx
export const Invoices = pgTable("invoices", {
    id: serial("id").primaryKey().notNull(),
    createTs: timestamp("createTs").defaultNow().notNull(),
    value: integer("value").notNull(),
    description: text("description").notNull(),
    userId: text("userId").notNull(),
    customerId: integer("customerId")
      .notNull()
      .references(() => Customers.id),
    status: statusEnum("status").notNull(),
});
```

### ุงูุดุฑุญ ุงูุชูุตููู:
1.  **`pgTable("invoices", ...)`**: ูุญู ููุง ูุฎุจุฑ Drizzle ุฃููุง ูุฑูุฏ ุฅูุดุงุก ุฌุฏูู ูู PostgreSQL ุงุณูู "invoices".
2.  **`id: serial(...).primaryKey()`**: ุงูู `serial` ูุนูู ุฑูู ูุจุฏุฃ ูู 1 ููุฒูุฏ ุชููุงุฆูุงู ูุน ูู ูุงุชูุฑุฉ ุฌุฏูุฏุฉ. ู `primaryKey` ุชุนูู ุฃูู ุงูุฑูู ุงููุฑูุฏ ุงูุฐู ูุง ูุชูุฑุฑ ุฃุจุฏุงู.
3.  **`createTs: timestamp(...).defaultNow()`**: ูุฐุง ุงูุญูู ูุณุฌู ููุช ุฅูุดุงุก ุงููุงุชูุฑุฉ ุชููุงุฆูุงู ูู ุงูุณุงุนุฉ ุงูููุฌูุฏุฉ ูู ุงูุณูุฑูุฑ ุฏูู ุชุฏุฎู ููู.
4.  **`value: integer`**: ุงุฎุชุฑูุง `integer` ูุชูุซูู ุงููููุณ. (ูุตูุญุฉ: ุจุฑูุฌูุงู ููุถู ุชุฎุฒูู ุงูุณุนุฑ ูู Cents - ุฃู ุงููุฌููุน ุจุงููุฑุด - ูุชุฌูุจ ูุดุงูู ุงููุณูุฑ ุงูุนุดุฑูุฉ ูู ุงูุญุณุงุจุงุช).
5.  **`userId`**: ูุฐุง ุงูุญูู ูุฑุจุท ุงููุงุชูุฑุฉ ุจูุณุชุฎุฏู **Clerk**. ูุฐุง ุฃูู ุญูู ููุฃูุงูุ ุจุฏููู ุณูุชููู ุฃู ุดุฎุต ูู ุฑุคูุฉ ููุงุชูุฑ ุบูุฑู.
6.  **`references(() => Customers.id)`**: ูุฐุง ูุณูู "ุงูุนูุงูุฉ" (Relationship). ูุญู ูููู ุฃู ุงููุงุชูุฑุฉ "ุชุชุจุน" ุนูููุงู ูุนููุงู ูู ุฌุฏูู ุงูุนููุงุก. ุฅุฐุง ุญุงููุช ุญุฐู ุนููู ุนููู ููุงุชูุฑุ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุณุชููุนู (Data Integrity).
7.  **`statusEnum`**: ูุถูู ุฃู ุงูุญุงูุฉ ูุง ุชุฎุฑุฌ ุนู (ูุฏููุนุ ููุชูุญุ ููุบู...) ููุง ูููุน ุงูุฃุฎุทุงุก ุงูุฅููุงุฆูุฉ ูู ุงูููุฏ.

---

## 2. ููุญุฉ ุงูุชุญูู - ุฌูุจ ูุญุณุงุจ ุงูุจูุงูุงุช
**ุงููุณุงุฑ:** `app/dashboard/page.tsx`

```tsx
const filteredResult = user ? await db.select()
    .from(Invoices)
    .innerJoin(Customers, eq(Invoices.customerId, Customers.id))
    .where(eq(Invoices.userId, user?.id))
    .orderBy(desc(Invoices.id)) : [];
```

### ุงูุดุฑุญ ุงูุชูุตููู:
1.  **`user ? ... : []`**: ูุชุญูู ุฃููุงู ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู. ุฅุฐุง ูู ูููุ ูุนูุฏ ูุตูููุฉ ูุงุฑุบุฉ ููุฑุงู.
2.  **`innerJoin`**: ูุฐู ูู ุงูููุฉ ุงูุญููููุฉ. ูุญู ูุทูุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: "ุฃุญุถุฑู ูู ุงููุงุชูุฑุฉ ูุจุฌุงูุจูุง ุจูุงูุงุช ุงูุนููู ุงูุฎุงุต ุจูุง". ูุฐุง ูููุฑ ููุช ุงูุณูุฑูุฑ (Query Optimization).
3.  **`eq(Invoices.customerId, Customers.id)`**: ุดุฑุท ุงูุฑุจุท. "ูุงุชู ุงูุจูุงูุงุช ุนูุฏูุง ูุชุณุงูู ุฑูู ุงูุนููู ูู ุงููุงุชูุฑุฉ ูุน ุฑูู ุงูุนููู ูู ุฌุฏูู ุงูุนููุงุก".
4.  **`where(eq(Invoices.userId, user?.id))`**: ุฃูู ููุชุฑ. "ุฃุญุถุฑู ููุท ุงูููุงุชูุฑ ุงูุฎุงุตุฉ ุจู ุฃูุง ููุณุชุฎุฏู ูุณุฌู ุญุงููุงู".
5.  **`orderBy(desc(Invoices.id))`**: ุชุฑุชูุจ ุชูุงุฒูู. ุงูููุงุชูุฑ ุงูุฌุฏูุฏุฉ ุชุธูุฑ ุฃููุงู.

---

## 3. ููุทู ุงูุณูุฑูุฑ (Server Actions)
**ุงููุณุงุฑ:** `app/actions.ts`

```tsx
export async function updateStatus(id: number, status: "open" | "paid" | "void" | "uncollectible") {
    await db.update(Invoices).set({ status }).where(eq(Invoices.id, id));

    if (status === 'paid') {
        // ... ุฅุฑุณุงู ุงูุฅูููู ...
    }
    revalidatePath(`/dashboard/invoices/${id}`, "page");
}
```

### ุงูุดุฑุญ ุงูุชูุตููู:
1.  **`"use server"`**: ูู ุจุฏุงูุฉ ุงููููุ ูุฎุจุฑ Next.js ุฃู ูู ูุฐู ุงูุฏูุงู ูุฌุจ ุฃู ุชุดูุฑ ูุชุนูู ููุท ุนูู ุงูุณูุฑูุฑุ ููุง ูููู ูููุณุชุฎุฏู ุฑุคูุฉ ุงูููุฏ ุงูุฏุงุฎูู ููุง (ุฃูุงู ุนุงูู).
2.  **`db.update(Invoices).set({ status })`**: ุฃูุฑ ูุจุงุดุฑ ููุงุนุฏุฉ ุงูุจูุงูุงุช ูุชุบููุฑ ูููุฉ ุญูู ุงูู status ููุงุชูุฑุฉ ูุนููุฉ.
3.  **`if (status === 'paid')`**: ููุทู (Trigger). ุฅุฐุง ุชุญููุช ุงูุญุงูุฉ ูู "ูุฏููุน"ุ ูุจุฏุฃ ุงููุธุงู ููุฑุงู ุจุชุดุบูู ูุญุฑู ุฅุฑุณุงู ุงูุฅููููุงุช.
4.  **`revalidatePath`**: ูุฐู ูู ููุฒุฉ Next.js ุงููุจุฑู. ุจุฏูุงู ูู ุฃู ูุถุทุฑ ุงููุณุชุฎุฏู ูุนูู Refresh ููุดุงูุฏ ุงูุชุบููุฑุ ุชุฎุจุฑ ูุฐู ุงูุฏุงูุฉ ุงููุธุงู: "ุงูุณุญ (Cache) ูุฐู ุงูุตูุญุฉ ูุฌุฏุฏ ุจูุงูุงุชูุง ููุฑุงู".

---

## 4. ุงููุณุงุฑ ุงูุฐูู ูุฅูุดุงุก ุงููุงุชูุฑุฉ
**ุงููุณุงุฑ:** `app/api/invoices/route.ts`

```tsx
const existingCustomer = await db
    .select()
    .from(Customers)
    .where(and(eq(Customers.userId, userId), eq(Customers.email, billingEmail)))
    .limit(1);

if (existingCustomer.length > 0) {
    customerId = existingCustomer[0].id;
} else {
    const newCustomer = await db.insert(Customers).values({
        name: billingName,
        email: billingEmail,
        userId: userId,
    }).returning();
    customerId = newCustomer[0].id;
}
```

### ุงูุดุฑุญ ุงูุชูุตููู:
1.  **`existingCustomer`**: ูุจู ุฃู ููุดุฆ ูุงุชูุฑุฉุ ูุจุญุซ: "ูู ุชุนุงูููุง ูุน ูุฐุง ุงูุฅูููู ูู ูุจูุ".
2.  **`and(...)`**: ูุณุชุฎุฏู ุดุฑุทุงู ูุฒุฏูุฌุงู. ูุฌุจ ุฃู ูููู ุงูุฅูููู ูู ููุณูุ ููุฌุจ ุฃู ูููู ุงูุนููู ูููุงู ูููุณุชุฎุฏู ุงูุญุงูู (ูุฃู ุฅูููู "Ahmed@test.com" ูุฏ ูููู ุนูููุงู ุนูุฏู ูุนูุฏู ูู ููุณ ุงูููุช).
3.  **`if (existingCustomer.length > 0)`**: ุฅุฐุง ูุงู ุงูุนููู ูุฏููุงูุ ูุฃุฎุฐ ุฑููู (ID) ููุฑุจุทู ุจุงููุงุชูุฑุฉ ุงูุฌุฏูุฏุฉ.
4.  **`else { ... .returning() }`**: ุฅุฐุง ูุงู ุฌุฏูุฏุงูุ ููุดุฆู ููุฑุงู ููุณุชุฎุฏู `returning()` ููุญุตู ุนูู ุงูู ID ุงูุฐู ุฃุนุทุชู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุญุงูุงู ููุถุนู ูู ุงููุงุชูุฑุฉ.

---

## 5. ูุฒุงููุฉ ุงููุณุชุฎุฏู (Clerk to Database)
**ุงููุณุงุฑ:** `app/dashboard/_components/UserSyncer.tsx`

```tsx
export default function UserSyncer() {
    const { user } = useUser()
    useEffect(() => {
        user && createNewUser()
    }, [user])

    const createNewUser = async () => {
        await axios.post("/api/user", {
            name: user?.fullName,
            email: user?.primaryEmailAddress?.emailAddress
        })
    }
    return null
}
```

### ุงูุดุฑุญ ุงูุชูุตููู:
1.  **`const { user } = useUser()`**: ูุณุญุจ ุจูุงูุงุช ุงููุณุชุฎุฏู ุงูุญุงูู ูู ูุธุงู **Clerk** (ุงูุงุณูุ ุงูุฅููููุ ุงูุตูุฑุฉ).
2.  **`useEffect`**: ุฏุงูุฉ ุชุนูู ุจูุฌุฑุฏ ูุชุญ ุงูุตูุญุฉ. ุจุฑูุฌูุงูุง ูุชุนูู "ูููุง ุชุบูุฑ ุงููุณุชุฎุฏู" (`[user]`).
3.  **`user && createNewUser()`**: ุฅุฐุง ูุฌุฏูุง ุฃู ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎููุ ูููู ุจุงุณุชุฏุนุงุก ุฏุงูุฉ ุงููุฒุงููุฉ.
4.  **`axios.post("/api/user", ...)`**: ูุฑุณู ุจูุงูุงุชู ููุณูุฑูุฑ ุงูุฎุงุต ุจูุง. ููุงูุ ุงูููุฏ ูููู ุจูุญุต: "ูู ูุฐุง ุงููุณุชุฎุฏู ููุฌูุฏ ูู ุฌุฏูู ุงูู Customers ุงูุฎุงุต ุจูุงุ ุฅุฐุง ูุงุ ุณุฌููู ูุนููู ููู ูุณุชุทูุน ุฑุจุท ููุงุชูุฑู ูุงุญูุงู".
5.  **`return null`**: ูุฐุง ุงููููู ูุง ูุธูุฑ ุฃู ุดูุก ุนูู ุงูุดุงุดุฉ (ููุณ ูู HTML)ุ ูู ูุฌุฑุฏ "ุนูู" ูุนูู ูู ุงูุฎูููุฉ.

---

## 6. ุงูุฏูุน ุนุจุฑ Stripe (Stripe Session)
**ุงููุณุงุฑ:** `app/actions.ts` -> `createPayment`

```tsx
const session = await stripe.checkout.sessions.create({
    line_items: [{
        price_data: {
            currency: 'usd',
            unit_amount: invoice.value * 100, // ุชุญููู ูุนุฏุฏ ุตุญูุญ (Cents)
        },
        quantity: 1,
    }],
    mode: 'payment',
    success_url: `.../payment?status=success`,
    metadata: { invoiceId: invoiceId.toString() },
});
```

### ุงูุดุฑุญ ุงูุชูุตููู:
1.  **`unit_amount: invoice.value * 100`**: ุณุชุฑุงูุจ ูุญุชุงุฌ ุงููุจูุบ ุจุงูู Cent. ููู ูุงูุช ุงููุงุชูุฑุฉ ุจู 10 ุฏููุงุฑุ ูุฑุณู ูู 1000.
2.  **`mode: 'payment'`**: ูุฎุจุฑ ุณุชุฑุงูุจ ุฃููุง ุนูููุฉ ุฏูุน ููุฑุฉ ูุงุญุฏุฉ (ููุณ ุงุดุชุฑุงูุงู ุดูุฑูุงู).
3.  **`success_url`**: ุงูุฑุงุจุท ุงูุฐู ุณูุนูุฏ ุฅููู ุงููุณุชุฎุฏู ุจุนุฏ ุฃู ูุฏูุน ุจูุฌุงุญ. ุจุฑูุฌูุงู ููุนูุฏ ูุตูุญุฉ ุงููุงุชูุฑุฉ ูุน ุฑุณุงูุฉ "ูุฌุงุญ".
4.  **`metadata`**: ูุฐู ุฃูู ุฎุงุตูุฉ. ุณุชุฑุงูุจ ูุง ูุนุฑู ูุงุนุฏุฉ ุจูุงูุงุชูุ ูุฐุง ูุถุน ูู "ุชุงุบ" ููู ุฑูู ุงููุงุชูุฑุฉ. ุนูุฏูุง ููุฌุญ ุงูุฏูุนุ ุณุชุฑุงูุจ ูุฑุณู ููุง ูุฐุง ุงูุฑูู ููุญุฏุซ ุญุงูุฉ ุงููุงุชูุฑุฉ ูู "Paid".

---

## 7. ุงูุญูุงูุฉ (Middleware)
**ุงููุณุงุฑ:** `middleware.ts`

```tsx
const isPublicRoute = createRouteMatcher(['/', '/sign-in(.*)', '/sign-up(.*)'])

export default clerkMiddleware(async (auth, req) => {
    if (!isPublicRoute(req)) {
        await auth.protect()
    }
})
```

### ุงูุดุฑุญ ุงูุชูุตููู:
1.  **`isPublicRoute`**: ูุงุฆูุฉ ุจู "ุงูููุงุทู ุงูููุชูุญุฉ" ุงูุชู ูุง ูุญุชุงุฌ ูููุง ูุชุณุฌูู ุฏุฎูู (ูุซู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ูุตูุญุงุช ุงูุฏุฎูู).
2.  **`(.*)`**: ูุฐุง ุงูุฑูุฒ ูุนูู "ูู ูุง ูุชุจุน ูุฐุง ุงูุฑุงุจุท". ูุซูุงู `/sign-in/anything` ุณุชููู ุนุงูุฉ ุฃูุถุงู.
3.  **`auth.protect()`**: ุฏุงูุฉ ูููุฉ ุฌุฏุงู. ุฅุฐุง ุญุงูู ุฃู ุดุฎุต ุฏุฎูู ุฃู ุฑุงุจุท ุบูุฑ ููุฌูุฏ ูู ุงููุงุฆูุฉ ุงูุนุงูุฉ (ูุซู `/dashboard`) ููู ููุณ ูุณุฌูุงูุ ูุชู "ุทุฑุฏู" ููุฑุงู ูุตูุญุฉ ุชุณุฌูู ุงูุฏุฎูู.

---
ูุฐุง ุงูุฏููู ูุบุทู ุฃูุซุฑ ูู **70%** ูู ุงูููุทู ุงูุจุฑูุฌู ุงูุญููู ูููุดุฑูุน. ูู ุฌููุฉ ุจุฑูุฌูุฉ ูู Invoicely ุชู ูุถุนูุง ูุบุฑุถ ูุญุฏุฏ: **ุงูุณุฑุนุฉุ ุงูุฃูุงูุ ุฃู ุณูููุฉ ุงูุงุณุชุฎุฏุงู.**
